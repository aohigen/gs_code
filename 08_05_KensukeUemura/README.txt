
今回は、前回の宿題でさわりを作成した日本の人口データの分析ツールをさらに充実させる形で対応しました。
特に力を入れたのは、「SQLへの複数条件検索機能」と「ユーザーの権限による機能管理」です。
※別のチューターの方が確認された時のために、前回のREADMEも下部に残しています。

また、前回はSQLを添付し忘れてしまったので、今回はきちんとSQLをエクスポートして添付しました。（SQLフォルダに格納）

【ご確認方法】
ログイン機能についてはまだやり方がわからないので、今回はfunc.phpにて、ユーザーは「$user_name = "kensuke"」というユーザーに固定しています。
ここを変えることで、ログインしているユーザーを切り替えることができます。（ログイン機能を習ったら切り替える予定）

まずは、login.phpをご確認ください。
こちらが起点となるページで、ログインと新規登録ができるようになっています。
前述の通り、ログインは未実装ですので、「新規登録」にお進みください。

その後index.phpが、ツールのフロントページです。
もう少し他のページも充実させたかったですが、ユーザー管理システムやアドバンスフィルタ（後述）に時間を取られ、サービスページはこのindex.phpのみとなっています。

【今回目指したこと】
機能としては、SQLへの複数条件のリクエスト機能と、ユーザー権限によって機能が変わるユーザー管理機能に力を入れました。

また、そろそろ2ヶ月経つので、部分部分ではなく、今回は出来るだけ「全体として完成した」ものにできるよう目指しました。
そのため、各箇所において工夫をしていますので、それを記します。

・register.php、insert.php
登録画面では、ユーザー名とパスワードをDBに探しにいき、すでに同じユーザー名が存在した場合と、パスワードが確認用と一致しない場合は、エラーとなって戻る仕組みを入れました。
また、エラー内容は赤字で警告されるように、気を使っています。

また、サービスとして展開した時を考え「サービスプラン」という属性を作っています。（ツール内で活用しています。※後述）

・index.php ヘッダー
ささやかですが「こんにちは○○さん」とユーザー名が動的に表示されるようにしています。
また、よくあるサービスのように、名前をクリックするとマイページへ遷移するようにしています。

ただグラフが見えるだけでは面白くないので、フィルタ機能をつけています。
また、項目は、一番左の分析軸を選択によって、二番目の項目が切り替わるようにしています。

前回、実装できなかった複数条件の機能である「アドバンスフィルタ」も実装に成功しました。
無制限に複数条件を増やすことができては、管理上も良くないので、３つまで増やすともう増やせないように条件追加ボタンを非表示にする処理をしています。
また、アドバンスフィルタはかなり苦戦しまして、ソースにも書きましたが、何故か変数で文字列としては正しいものが出力されているのに、それをprepare分に変数で代入すると何も帰ってこない事象にぶつかりました。
これはprepareを複数箇所に書くことで回避しましたが、最適な方法ではないかなとは考えています。
（また、分析軸によって項目を制御するのは、通常のフィルタ機能の影響を回避することができず、ここも甘いところとなっています。）

・グラフ
グラフのリアルタイムの切り替えにも挑戦したく、グラフ上部の「人数/成長率」ボタンで、人口数と前期間ごとの成長率に切り替えられるようにしました。
比較的スムーズな挙動が実現できたかなと思います。
その他、BootStrapのテンプレートを活用して、枠をいろんな計算指標で表示してみました。

・ユーザー権限ごとの表示切り替え
完成したサービスをイメージした場合、無料プランと有料プランのユーザーによって機能を出し分けたいと考えました。
そこで、「フィルタ機能」は、DBのuser_tableのplan属性にて「free」のユーザーには表示されず、有料プランへの案内を表示するようにしました。

また、デフォルトのユーザーであるkensukeは管理者ですので標準で表示されていますが、サイドバーの「ユーザー管理」というリンクは、DBでadmin_flgが0以外の場合のみしか表示されないようにしています。
これにより、管理者用専門ページを作る負荷をなくしています。


・mypage.php
Register.php同様に入力エラー機能を実装しています。
全てのユーザー情報が、ユーザー自身で編集できるようにしています。

・admin.php
ユーザーの一覧を見えるようにしたページです。必要最低限の情報は一覧で見えるようにしています。
ここで、ユーザーを編集、削除をすることができます。
削除は、本当はアラートを挟んでから削除をしたかったのですが、時間なく間に合わずでした。

・admin_user
管理者用のユーザー情報編集画面です。
初めは、admin.phpと同じページで、例の権限による表示非表示で作成していたのですが作成の過程で
バグで管理者用の内容が表示してしまったりしているうちに、「もし本番だったら誤っても管理者用の
情報は表示される事故は防がなければならないのでは？」と考えて、やや手間ですが別ページにしました。

管理者用の編集ページでは、何かとユーザー管理に役立ちそうな「ステータス」という属性も作って、
ステータス管理もできるようにしました。

・その他
その他は、アドバンスフィルタの表示方法などの使いやすさや、ちょっとした文字の大きさの調整による見易さにこだわりました。
細かいところを詰めていったので、報告漏れしている機能もあるかもしれません。

また、できる限りバグをなくすことにも気を配りましあが、やはりまだまだできていないことだらけです。
完成品を作る際は、細部の詰めは本当に大変だなと感じました。


今回は結構頑張りました！
以上となります。



============================
以下は前回のREADME
============================
SQLを使った何かしらの分析ツールを作ろうと思い、政府が公開している人口のデータを元にWEB上で視覚的に分析できるツールを作りました。

工夫した点は、BootStrapを初めて使ってみて、カスタマイズをして見た目的にも完成度の高いものにできるようにしました。
BootStrapのテンプレートはかなり複雑で、まだ今の段階ではソースが煩雑だと理解が遅くなるので、不要な部分はすべて削除をしてスッキリとさせました。

人口データ（dataフォルダに格納）は、各年代や都道府県ごとに別れていたため、初回のグラフ描写ではWHEREで総数だけに絞ることで年ごとのグラフに絞り込みました。
また、男女比も同時に視覚的に見れたら良いと思い、Chart.jsを使って、3軸の折れ線グラフにしました。

また、様々なデータの絞り込みもしたいと考え、ヘッダーにてフィルタ機能を実装しました。
授業でもらったサンプルコードでは、SQLを一行で書いてありましたが、個人的にフィルタ機能を作る際には、SELECT、FROM、WHERE、GROUPBYという各要素ごとに変数で分けた方がコントロールしやすかったため、変数を分けて最後に組み合わせる形に工夫をしました。

また、細かいですが、主軸となる「都道府県」「年齢」「西暦」によって項目が分かれるため、ここはjQueryを使って、選ばれた項目ごとに選択肢を表示非表示でコントロールをして、余計な選択肢が表示しないように配慮しました。
フィルタの部分が情報量が多くなってしまいソースが重たくなってしまったため、phpで外部ファイル読み込みにすることでソースの簡素化も行いました。


BootStrapのフォーマットに合わせて、SQLで取得をした数値を「最大値」「最大値比」「女性率」と言った指標に計算を行いました。
また「人口の変化」の下に指定された対象期間が動的に切り替わるようになど、テンプレートのデザインを生かした細かい動的値の表示にもこだわりました。（ページ下部の〇〇年前比、と言った箇所も、動的にゲージが変わるようにしています）

また、グラフのアップデートもやってみたく、人数だけでは見えにくい「増加率」という指標も.length[i]/.length[i-1]というシンプルな計算で導いて、クリックすると切り替えられるようにしました。


未対応箇所について。
「期間」というボタンで、グラフの対象期間もモーダルで選べるようにしたかったですが、ここは間に合わず未対応となっています。
また、時間があればいろいろな公開データをデータベースに保存をして、様々なデータを分析できるようにしたかったですが、ここも間に合わずサイドメニューはすべてダミーで項目が書いてあるだけとなります。

あとは、現在は単一条件のフィルタしかかけられませんが、複数条件のフィルタも作りたかったですが、こちらはどちらかというとデザイン面でどのような方法が最適かを考えるに時間が必要と考え、ノンタッチとなっています。
最近ではドラッグ＆ドロップでルールが作成できるツールも増えているので、何か、このような検索機能のデザインテンプレートなどがあれば、ぜひご教授いただきたいです。
